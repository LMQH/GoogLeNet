# 基于GoogLeNet的卡牌识别分类系统

## 项目概述

基于PyTorch框架实现的深度学习图像分类系统，采用GoogLeNet（Inception v1）网络架构对53类卡牌进行识别分类。项目使用Kaggle公开数据集（7624张图像），通过迁移学习、混合精度训练、学习率调度等优化策略，实现了高精度的多分类任务，并支持ONNX模型导出用于生产环境部署。

---

## 技术要点

- **PyTorch深度学习框架**：构建完整的训练-验证-测试流程
- **GoogLeNet（Inception v1）网络**：多尺度特征提取，辅助分类器辅助训练
- **迁移学习**：ImageNet预训练权重初始化，冻结浅层特征提取层
- **混合精度训练（AMP）**：降低显存占用，加速训练过程
- **OneCycleLR学习率调度**：动态调整学习率，提升收敛速度
- **数据增强策略**：高斯模糊、随机裁剪、旋转、色彩抖动、透视变换、随机擦除
- **AdamW优化器**：权重衰减正则化，防止过拟合
- **标签平滑（Label Smoothing）**：软化one-hot标签，提升泛化能力
- **早停机制（EarlyStopping）**：监控验证集准确率，避免过度训练
- **TensorBoard可视化**：实时监控训练指标、损失曲线、混淆矩阵
- **ONNX模型导出**：支持跨平台推理部署
- **自适应批处理大小**：根据GPU显存自动计算最优batch_size

---

## 代码逻辑与架构分析

### 1. 数据处理模块（data/dataloader.py）
**功能**：负责数据集加载、预处理和增强
- **训练集增强**：应用高斯模糊、随机裁剪（95%-100%缩放）、随机旋转（±5°）、色彩抖动（亮度/对比度/饱和度±10%）、仿射变换（平移±5%、缩放97%-103%）、透视变换（15%概率）、随机擦除（15%概率），增强模型鲁棒性
- **验证/测试集预处理**：仅进行尺寸调整（224×224）和ImageNet标准归一化
- **DataLoader配置**：启用`pin_memory`加速GPU数据传输，多线程并行加载

### 2. 模型定义模块（models/GoogLeNet.py）
**功能**：自定义GoogLeNet网络结构并实现迁移学习
- **预训练加载**：使用`GoogLeNet_Weights.IMAGENET1K_V1`初始化权重
- **层级冻结策略**：冻结浅层卷积特征提取层，解冻`inception4e`、`inception5a`、`inception5b`三个深层模块进行微调
- **分类器替换**：主分类器和两个辅助分类器（aux1/aux2）的全连接层替换为`Dropout + Linear`结构，适配53类输出
- **动态前向传播**：训练模式返回三个输出（main, aux1, aux2），推理模式仅返回主输出

### 3. 训练控制模块（training/）

#### 3.1 train.py - 主训练逻辑
**功能**：实现完整的训练循环和优化策略
- **混合精度训练**：使用`autocast`和`GradScaler`实现FP16计算，降低显存和提升速度
- **辅助分类器损失**：主输出损失 + 0.3 × (辅助分类器1损失 + 辅助分类器2损失)
- **OneCycleLR调度**：每个batch后更新学习率，最大学习率为基础学习率的3倍
- **早停监控**：每个epoch后检查验证集准确率，若连续10个epoch无提升则提前终止
- **ONNX导出**：训练完成后自动导出最佳模型为ONNX格式（支持动态batch_size）

#### 3.2 early_stop.py - 早停机制
**功能**：防止过拟合，保存最佳模型
- **准确率监控**：跟踪验证集准确率，当提升小于阈值（delta=0.001）时计数器+1
- **模型保存**：验证准确率提升时自动保存模型权重

#### 3.3 evaluate.py - 模型评估
**功能**：在验证集/测试集上评估模型性能
- **无梯度推理**：使用`torch.no_grad()`加速评估
- **实时进度显示**：通过tqdm显示当前batch的损失和准确率

### 4. 测试评估模块（testing/）

#### 4.1 test.py - 测试脚本
**功能**：模型测试并生成详细评估报告
- **多指标计算**：准确率、宏平均精确率/召回率/F1-Score
- **混淆矩阵可视化**：生成53×53混淆矩阵热力图并记录到TensorBoard
- **分类报告生成**：输出每个类别的precision/recall/f1-score，并导出为Excel文件

#### 4.2 inference.py - ONNX推理
**功能**：使用导出的ONNX模型进行单张图像推理
- **ONNX Runtime加速**：优先使用CUDA加速推理
- **置信度过滤**：低于30%置信度的预测标记为"未知类别"
- **类别映射**：从测试集文件夹结构自动加载53个类别名称

### 5. 工具模块（utils/）

#### 5.1 logger.py - TensorBoard日志
**功能**：集中管理训练过程的日志记录
- **自动目录管理**：根据实验名称和时间戳创建日志目录
- **多类型记录**：支持标量（损失/准确率）、图像（混淆矩阵）、文本（分类报告）、超参数记录
- **队列优化**：设置`max_queue=50`和`flush_secs=300`平衡写入性能

#### 5.2 metrics.py - 评估指标
**功能**：计算和可视化模型性能指标
- **宏平均指标**：计算precision/recall/f1-score的宏平均值（对类别不平衡更敏感）
- **混淆矩阵绘制**：动态调整图像大小（最小8×6，根据类别数缩放），使用蓝色热力图
- **Excel报告导出**：将分类报告转换为DataFrame并保存为xlsx文件

### 6. 配置管理（config.py）
**功能**：集中管理所有超参数
- **自适应配置**：根据GPU显存自动计算batch_size（经验公式：`min(128, GPU_GB * 32)`）
- **超参数定义**：训练轮数60、Dropout概率0.2、学习率3e-4、权重衰减1e-4、标签平滑0.2等
- **路径配置**：数据集路径、模型保存路径、日志路径统一管理

### 7. 主程序（main.py）
**功能**：整合所有模块，执行完整的训练-测试流程
- **流程编排**：数据加载 → 模型初始化 → 优化器/调度器配置 → 训练 → 测试
- **设备管理**：自动检测CUDA可用性，配置cuDNN优化
- **性能优化**：启用`cudnn.benchmark`加速固定输入尺寸的卷积运算

---

## 项目亮点

1. **工程化设计**：模块化架构清晰，各功能解耦，易于维护和扩展
2. **性能优化全面**：混合精度训练、自适应批处理、cuDNN优化等多维度提速
3. **训练策略完善**：结合迁移学习、数据增强、标签平滑、早停等多种技术防止过拟合
4. **可视化与监控**：TensorBoard实时监控，混淆矩阵/分类报告自动生成
5. **生产部署就绪**：支持ONNX导出，可部署到移动端、边缘设备或推理服务器
